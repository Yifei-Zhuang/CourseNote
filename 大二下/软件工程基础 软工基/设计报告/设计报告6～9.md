## 6 数据库设计

### 6.1 UML图

![image-20220509203033356](/Users/zhuangyifei/Library/Application Support/typora-user-images/image-20220509203033356.png)

### 6.2 逻辑结构设计

##### 证券账户类型

​	security_type (<u>securityid</u>, accountType)

##### 个人证券账户

​	personSecurity (<u>securityid</u>, registerdate, name, gender, identityid, homeaddress, work, education, workaddress, phone, agentidentityid, accountstate)

##### 法人证券账户

​	corporateSecurity (<u>securityid</u>, corporateregisterid, licenseid, corporateidentityid, corporatename, corporatephone, contactaddress, authorizername, authorizeridentityid, authorizerphone, authorizeraddress, accountstate)

##### 证券管理人员相关信息表 

​	securitiesadministrator(<u>username</u>, password)

##### 资金账户信息表

​	capitalaccount (<u>capitalaccountid</u>, identityid, securityId, balance, tradepassword, cashpassword, frozenmoney, accountstate, interest)

##### 资金账户收支信息

​	transactions (<u>id</u>, capitalaccountid, time, amount, currency, description)

### 6.3 物理结构设计

#### 6.3.1 证券账户类型

| 字段        | 类型                        | 是否为空 | 是否主键 | 备注                             |
| ----------- | --------------------------- | -------- | -------- | -------------------------------- |
| securityid  | varchar(18)                 | 否       | 是       | 证券账户的唯一标识符，由系统生成 |
| accountType | enum('person', 'corporate') | 否       | 否       | 表示账户是个人账户还是法人账户   |

#### 6.3.2 个人证券账户

| 字段        | 类型                        | 是否为空 | 是否主键 | 备注                             |
| ---- | ---- | ---- | ---- | ---- |
| securityid | varchar(18) | 否 | 是 | 证券账户的唯一标识符，由系统生成<br />外键：证券账户类型 |
| registerdate | timestamp | 否 | 否 | 账户注册时间 |
| name | varchar(50) | 否 | 否 | 个人姓名 |
| gender | enum('male', 'female') | 否 | 否 | 性别 |
| identityid | varchar(18) | 否 | 否 | 身份证号 |
| homeaddress | varchar(80) | 否 | 否 | 家庭住址 |
| work | varchar(50) | 否 | 否 | 工作职业 |
| education | varchar(40) | 否 | 否 | 教育经历 |
| workaddress | varchar(50) | 否 | 否 | 工作地址 |
| phone | varchar(30) | 否 | 否 | 电话 |
| agentidentityid | varchar(20) | 是 | 否 | 委托人id， 可为空 |
| accountstate | enum('normal', 'forzen', 'cancel') | 否 | 否 | 账户状态 |

#### 6.3.3 法人证券账户

| 字段                 | 类型                               | 是否为空 | 是否主键 | 备注                                                     |
| -------------------- | ---------------------------------- | -------- | -------- | -------------------------------------------------------- |
| securityid           | varchar(18)                        | 否       | 是       | 证券账户的唯一标识符，由系统生成<br />外键：证券账户类型 |
| corporateregisterid  | varchar(50)                        | 否       | 否       | 法人注册id                                               |
| licenseid            | varchar(50)                        | 否       | 否       | 营业执照id                                               |
| corporateidentityid  | varchar(18)                        | 否       | 否       | 法人身份证                                               |
| corporatename        | varchar(50)                        | 否       | 否       | 法人姓名                                                 |
| corporatephone       | varchar(30)                        | 否       | 否       | 法人电话                                                 |
| contactaddress       | varchar(50)                        | 否       | 否       | 法人联系地址                                             |
| authorizername       | varchar(50)                        | 否       | 否       | 授权者姓名                                               |
| authorizeridentityid | varchar(18)                        | 否       | 否       | 授权者身份证号                                           |
| authorizerphone      | varchar(30)                        | 否       | 否       | 授权者电话                                               |
| authorizeraddress    | varchar(50)                        | 否       | 否       | 授权者地址                                               |
| accountstate         | enum('normal', 'forzen', 'cancel') | 否       | 否       | 账户状态                                                 |

#### 6.3.4 证券账户密码表

| 字段       | 类型        | 是否为空 | 是否主键 | 备注                                                     |
| ---------- | ----------- | -------- | -------- | -------------------------------------------------------- |
| securityid | varchar(18) | 否       | 是       | 证券账户的唯一标识符，由系统生成<br />外键：证券账户类型 |
| password   | varchar(20) | 否       | 否       | 加密之后的密码                                           |
#### 6.3.5 证券管理人员相关信息表 

| 字段     | 类型        | 是否为空 | 是否主键 | 备注         |
| -------- | ----------- | -------- | -------- | ------------ |
| username | varchar(20) | 否       | 是       | 管理人员账号 |
| password | varchar(50) | 否       | 否       | 管理人员密码 |

#### 6.3.6 资金账户信息表

| 字段             | 类型                               | 是否为空 | 是否主键 | 备注                               |
| ---------------- | ---------------------------------- | -------- | -------- | ---------------------------------- |
| capitalaccountid | varchar(20)                        | 否       | 是       | 账号id                             |
| identityid       | varchar(18)                        | 否       | 否       | 身份证                             |
| securityId       | varchar(18)                        | 否       | 否       | 证券账户id<br />外键：证券账户类型 |
| balance          | decimal(10,2)                      | 否       | 否       | 余额                               |
| tradepassword    | varchar(50)                        | 否       | 否       | 交易密码                           |
| cashpassword     | varchar(50)                        | 否       | 否       | 存款 取款密码                      |
| frozenmoney      | decimal(10,2)                      | 是       | 否       | 冻结的钱                           |
| accountstate     | enum('normal', 'forzen', 'cancel') | 否       | 否       | 账户状态                           |
| interest         | decimal(10,2)                      | 否       | 否       | 未取利息                           |

#### 6.3.7 资金账户收支信息

| 字段             | 类型                                                         | 是否为空 | 是否主键 | 备注                                 |
| ---------------- | ------------------------------------------------------------ | -------- | -------- | ------------------------------------ |
| id               | primary key                                                  | 否       | 是       | 系统生成的唯一id                     |
| capitalaccountid | varchar(20)                                                  | 否       | 否       | 资金账户id<br />外键：资金账户信息表 |
| time             | timestamp                                                    | 否       | 否       | 时间                                 |
| amount           | decimal(25, 2)                                               | 否       | 否       | 交易额                               |
| currency         | enum('RMB', 'USD', 'CAD', 'AUD', 'EUR', 'GBP', 'HKD', 'JPY') | 否       | 否       | 币种                                 |
| description      | varchar(500)                                                 | 是       | 否       | 交易描述                             |

## 7 运行设计

### 7.1 运行模块组合

​	本子系统按照功能划分模块，每个模块又按流程划分为客户端界面、客户端脚本、服务器后台程序。功能模块之间会共享部分界面(导航栏等)。

### 7.2 运行控制

#### 7.2.1 证券账户管理系统

##### 7.2.1.1 管理员操作

- 执行个人开户

  管理员可以为个人用户进行开户操作。个人用户需要提交开户所需的信息，包括登记日期、姓名、性别、身份证号、家庭地址、职业、学历、工作单位、联系电话（若为代办，则提供代办人身份证）。在后端检查用用户信息合法之后，将为其创建相关账户，并将对应的证券账户id返回给用户，用户之后需要对所开的账户设置密码。

- 执行法人开户

  管理员可以为法人用户进行开户操作。法人用户需要提交开户所需的信息，包括有效的法人注册登记号码、营业执照号码、登记日期、法定代表人的姓名、性别、身份证号、家庭地址、联系电话、法定代表人授权证券交易执行人的姓名、身份证号、联系电话、地址、在后端检查用用户信息合法之后，将为其创建相关账户，并将对应的证券账户id返回给用户，用户之后需要对所开的账户设置密码。

- 执行挂失

  用户提供本人身份证或法人注册登记号，如果通过验证，那么冻结该资金账户下所有的资金和证券账户下所有的证券。

- 执行补办

  用户提供开户必须的信息，管理人员按照开户手续，为用户重新申请证券账户，并重新将新的证券账号和原有资金账号关联，随后管理人员将新的证券账号告知用户，用户重新设置证券账户密码。

- 执行销户

  用户在销户之前取出账户内所有证券并取出与该证券账户相关联的资金账户中的所有现金，随后用户向管理员提供相关信息：本人身份证或法人注册登记号，证券账户卡和证券账户密码。通过验证之后系统将该证券账户关联的资金账户与之分离，随后工作人员冻结该资金账户下所有的资金和证券账户下所有的证券，将其一并注销。

用户：

- 修改密码

  用户向管理人员提供自己的账户、旧密码和新密码，经过验证之后系统更新证券账户对应的密码。

### 7.2.2 资金账户管理系统

管理员：

- 个人开户

  管理员可以为用户进行资金账户开户操作。用户需要提交开户所需的信息，包括有效的本人身份证、证券账户卡、证券账户密码、欲绑定的银行卡号、开户行、银行卡密码，在后端检查用用户信息合法之后，将为其创建相关账户，并将新开设的初始资金账户和该账户的证券账户相关联，存入数据库，随后将已开设的账户告知开户者，开户者设置交易密码和取款密码。

- 挂失

  管理员可以为用户进行资金账户挂失操作。用户提供相关信息：本人身份证或法人注册登记号，证券账户号，和证券账户密码。工作人员查询相应类型账户并验证身份信息的对应性，若验证全部通过，工作人员冻结该资金账户下所有的资金和证券账户下所有的证券。

- 补办

  管理员可以为用户进行资金账户挂失操作。用户提供相关信息：本人身份证或法人注册登记号，证券账户号，和证券账户密码。工作人员查询相应类型账户并验证身份信息的对应性，若验证全部通过，工作人员按照开户手续为用户重新办理资金账户，并将丢失账户中的所有信息（包括资金数量）复制到新账户中。工作人员将旧资金账户注销，将新账户与用户的证券账户绑定。工作人员将新的资金账号告知用户，用户设置新的交易密码和取款密码。

- 销户

  管理员可以为用户进行资金账户销户操作。用户需要在销户之前取出该资金账户中的所有现金，随后用户向管理员提供相关信息：本人身份证或法人注册登记号，证券账户卡和资金账户卡，证券账户密码和资金账户密码。验证通过之后系统将该资金账号和证券账号分离，注销该资金账户。

- 修改密码

  管理员可以为用户进行资金账户修改密码操作。用户向管理员提供相关信息：原有资金账户号和交易密码或存取款密码，经过验证之后工作人员修改该账户交易密码或存取款密码。

- 资金账户取款

  管理员可以为用户进行资金账户取款操作。用户提供相关信息：资金账户号，取款密码和需要取出的金额。工作人员验证账号密码是否正确，若正确，查询资金账户中的可用现金，若可用现金足够取出，则将用户所需的金额交付给用户，工作人员更新账户可用现金的值。

- 资金账户存款

  管理员可以为用户进行资金账户存款操作。用户向工作人员提供：资金账户号，取款密码，需要存入的金额和相应钱币。工作人员验证账号密码是否正确，若正确，工作人员将相应金额收取后，更新账户可用现金的值。

用户：

- 资金账户登陆

  用户输入资金账户号和交易密码，服务器验证账号密码是否正确，若正确，则登陆成功，进入资金管理系统主页面，若不正确，则驳回登陆申请。

- 资金账户取款

  用户提供相关信息：取款密码和需要取出的金额，取出资金汇入的银行卡号，系统验证账号密码是否正确，若正确，查询资金账户中的可用现金，若可用现金足够取出，系统将用户所需的金额转入用户提供的银行卡，并更新账户可用现金的值。

- 资金账户存款

  用户提供相关信息：需要存入的金额，用于取出资金的银行卡号和该银行卡密码，系统验证银行卡号和密码是否正确，若正确，使用该密码查询银行卡中的可用现金，若可用现金大于等于用户提供的金额，则将用户所需的金额从银行卡中取出，存入该用户的资金账户，系统随后更新该资金账户可用现金的值

- 资金信息查询

  在用户成功登陆的前提下，用户可以执行资金信息查询操作，系统将会查询该资金账户的可用现金余额、开户者姓名、近期交易明细等信息，并在浏览器中显示查询所得信息。

服务器：

- 资金账户利息更新

  系统查询各资金账户的可用现金余额，对于余额大于等于0的用户，按照当前余额*0.35%计算利息，并将各账户利息存入对应账户的余额中。



## 8 系统出错设计

### 8.1 出错信息

| 系统输出错误的形式 | 含义                                                         | 处理办法或相应对策                                           |
| ------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 数据库连接失败     | 1. 数据库配置出错<br />2. 数据库连接数超过访问量上限         | 1. 修改数据库配置<br />2. 限制并发访问量                     |
| 用户名密码错误     | 1. 用户忘记密码 <br />2. 被他人恶意篡改密码                  | 返回相应的错误信息给用户，通过登录界面的“找回密码”进行密码修改 |
| 服务器暂时无法访问 | 1. 服务器正在维护中<br />2. 短时间内有大量流量导致服务器瘫痪 | 对于情况2，联系系统管理员进行紧急处理                        |
| 非法访问           | 部分用户企图访问管理员界面或后台程序，窃取网站               | 限制普通用户越权访问，通过各种手段保护后台数据               |
| 无法读取磁盘内容   | 磁盘受损                                                     | 对磁盘与数据库进行周期性的备份                               |

### 8.2 补救措施 

#### 8.2.1 系统恢复

​	磁盘受损对磁盘与数据库进行周期性的备份

​	系统崩溃后，根据系统运行日志恢复系统和数据，并重新启动系统。

#### 8.2.2 定时备份

1. 周期性地备份数据库中的数据，将其存储在更稳定的介质上，并及时进行校对、更新。
2. 将工程代码通过GitHub进行完善的版本管理。

#### 8.2.3 人工操作

​	当出现紧急情况时，数据库管理员人工地对数据库中数据进行修改，并做相应的记录。

### 8.3 系统维护设计

​	由于实验条件有限，我们并不能提供专门的服务器运行系统，故将利用配置较高的PC作为服务器，保证服务器以及客户端间网络畅通即可。

1. 用户在该系统执行操作时应该留下痕迹，以方便检查系统是否被恶意篡改。同时系统管理员定时查看系统日志，统计非法攻击来源和次数，并针对相应攻击加强安全防范措施。
2. 系统管理员的登录不仅需要账户密码，还需要识别IP，禁止非白名单IP的任何访问。

3. 系统维护人员及时更新技术漏洞，通过各种手段防止各种对系统的攻击，增强代码的可靠性。
4. 定期维护数据库，涉及到检查数据库表、检查日志文件等，确保数据库内数据的正确性。
5. 在可能出错的地方使用try-except语句捕获异常，并输出相应的出错信息和可能的处理方法提示。



## 9 需求回溯

### 9.1 功能性需求回溯

| 需求ID | 需求简述                                 | 对应的设计模块                     | 实现方式                                                     |
| ------ | ---------------------------------------- | ---------------------------------- | ------------------------------------------------------------ |
| A01    | 用户身份有效性核验                       | 资金账户管理系统和证券账户管理系统 | 页面加载时，服务器验证Session或者Token是否过期，如果过期则重定向到所有子系统统一的登录界面。否则用户将根据Session中存储的身份信息，拥有不同的模块功能。 |
| A02    | 为管理员提供证券账户管理功能             | 证券账户管理系统                   | 管理员通过用户身份有效性核验之后，管理员获得证券账户系统数据库超级用户权限，管理员可以执行开户、挂失、补办、销户等操作修改各个数据表的内容，也可以查看所有账户的信息。 |
| A03    | 为管理员提供资金账户管理功能             | 资金账户管理系统                   | 管理员通过用户身份有效性核验之后，管理员获得资金账户系统数据库超级用户权限，管理员可以执行开户、挂失、补办、销户、存款、取款等操作修改各个数据表的内容，也可以查看所有账户的信息。 |
| A04    | 为用户提供存取款管理方式                 | 资金账户管理系统                   | 用户通过用户身份有效性核验之后，可以向系统提供鉴权的进一步信息以及存款/取款金额、币种等信息，系统在执行鉴权操作之后是情况决定是否执行进一步操作。 |
| A05    | 为用户提供资金账户总信息以及明细查询功能 | 资金账户管理系统                   | 用户通过用户身份有效性核验之后，可以查询资金账户的详细信息，以及查询资金账户的交易明细。 |

### 9.2 性能及安全需求

| 需求ID | 需求简述                                                     | 实现方式                                                     |
| ------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| B01    | 【安全性】用户账户安全                                       | 使用jwt生成对应的Token执行鉴权                               |
| B02    | 【安全性】数据库数据保护，防止用户恶意访问数据库或者破坏数据库 | 1. 使用占位符进行查询参数绑定<br />2. 数据库根据不同的用户赋予不同的最小需要的操作权限 |
| B03    | 【性能】能够应对数据库访问量过大的情况以及通过大量访问量来实现攻击的手段 | 对于频繁访问数据库的操作，需要建立索引                       |
| B04    | 【性能】客户端通过网页展现给用户一个友好、易于操作的界面     | 通过BootStrap、Scss或其他ui框架和定义外部CSS样式表实现扁平化样式与栅格排版，使用JavaScript实现数据的动态显示和交互 |



























