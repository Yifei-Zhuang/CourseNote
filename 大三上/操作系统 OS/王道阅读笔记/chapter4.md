

# 文件管理

## 1. 文件系统基础

- 文件目录也是一个文件，叫做目录文件

- 文件存储结构

  - FCB将文件名和文件描述存储在一起，一个存储单元将文件的信息，包括文件的基本信息、文件的存储控制信息、使用信息等存储在一起，用来实现按名存储
  - i节点（索引节点）：有时候，我们只需要文件名组成的目录，这时候不需要存储FCB。于是将文件名和文件描述信息分开，目录项仅仅含有一个文件名和指向文件描述信息的指针，这样进行文件扫描的时候使得一页中能够存储更多的文件信息，减少查找指定文件时的文件读取次数。

- 文件逻辑结构

  - 无结构文件（流式文件）
  - 有结构文件
    - 顺序文件
    - 索引文件
    - 索引顺序文件
      - 如果有N条记录，那么最好的情况下平均只需要查找$\sqrt{N}$次
    - 直接文件或者散列文件

- 文件物理存储方式

  - 连续存储

    - 优点：
      - 按照最优分配原则进行分配，实现简单，存取速度快
    - 缺点：
      - 文件长度不宜变化
      - 容易产生外部碎片
      - 不适用于长度变化的文件

  - 链接分配

    - 不会有外部碎片
    - 实现方式
      - 隐式链接
        - 目录项中含有第一项和最后一项的指针，整体结构类似一个链表，使用的时候遍历即可，适合于顺序访问
        - 缺点：一旦文件损坏，就找不到下一个盘块的地址，造成文件丢失。
        - 一般使用方式：将多个盘块组装成簇，按照簇分配，这样做增加了内部碎片，但是可以减少访问时间。
      - 显式链接
        - 存储在内存中的一个表。标记了文件对应的首地址，以及每一个地址的下一个地址。
        - ![](https://raw.githubusercontent.com/workflowBot/image_bed/main/uPic/8RGfBg.png)
        - FAT中不需要存储盘块号，直接存储下一块地址就行
        - 计算例子
        
          >一页1k，一共540M，FAT至少多少
          >
          >注意到一共有540K，需要20bit进行区分，那么至少要20bit * 540K = 1350KB
        - 提升了检索速度
  
  - 索引分配
  
    - 解决问题
  
      - 链接分配不能有效解决直接访问问题（比如我想要直接访问某一个文件中的某一块，FAT除外）
      - FAT表本身需要较大的内存空间存储

    - 解决方法：在磁盘中存储索引块，其中（按顺序）专门存储本文件的各个块的地址，这样访问文件的时候可以直接访问给定的块而不用顺着链表查询，并且也不需要将整个FAT表读入。

      ![](https://raw.githubusercontent.com/workflowBot/image_bed/main/uPic/7rLKrG.png)

    - 为了支持大文件的实现方式：

      - 链接方案：多个快链接在一起

      - 多层索引：类似多级页表

      - 混合索引：将上述两种策略结合，UNIX实现策略

        - 针对小文件，中文件和大文件使用不同的存储方式

        - 如果是小文件，那么直接将磁盘地址存储在FCB中，访问的时候只需要访问一次磁盘

        - 如果是中文件，那么除上述存储的数据之外，另外存储索引块的磁盘地址，访问的时候首先先读入索引块，之后遍历索引块中的有效地址进行IO就可以将文件的信息读入。这样做多了一次IO（即读入索引块）

        - 如果是特大文件，那么除了上述两种方式存储的数据之外，使用多级索引的方式进行磁盘访问。
  
        - unix中的实现。
  
          ![](https://raw.githubusercontent.com/workflowBot/image_bed/main/uPic/4OZvXl.png)
  
          - 在iaddr0->9中存储了10个直接的磁盘地址，最多存储40kB（如果一页是4kB）
          - 在iaddr10中存储了一级间接寻址，最多存储4MB + 40KB
          - 在iaddr11中存储了二级间接寻址，最多存储4GB + 4MB + 40KB
          - 在iaddr12中存储了三级简介寻址，最多存储4TB + 4GB + 4MB + 40KB
  
- 相关计算题

  - ![](https://raw.githubusercontent.com/workflowBot/image_bed/main/uPic/mAau0c.png)

    >![](https://raw.githubusercontent.com/workflowBot/image_bed/main/uPic/p8RgLT.png)
    >
    >1. 注意这里计算平均访问次数的时候不是直接➗2，而是要用一个加权方式计算
    >2. 注意分离之后，要访问一个FCB需要先访问索引拿到地址，这样至少需要2次访问磁盘
  
  - ![](https://raw.githubusercontent.com/workflowBot/image_bed/main/uPic/5irq24.png)

    >第一题和第二题比较简单，这里不细讲
    >
    >第三题，注意fat中每一个表项存储的都是下一个表项的index，所以106应该存储在100中，108存储在106中，
    >
    >==第四题，这是重点==，注意FAT表始终驻留在内存中，所以要访问dir/dir1/file1的第5000字节的时候，首先读取第48块（注意这里要访问，不然只有fat表，不知道file1首块在哪里），读取之后知道file1的首块在100块，之后==直接在内存中的fat表查到100的下一块是106==，于是直接访问106块拿到数据。
    >
    >这里也列出dir等文件的信息
    >
    >簇1： 
    >
    >dir1 48
    >
    >簇48:
    >
    >file1 100
    >
    >file2 200
    >
    >
    >
    >





























