# I/O

## 1. IO概述

### 1.1 IO设备

- 分类

  - 块设备
  - 字符设备

- 实现方式

  - 独立编址，也就是直接为IO设备分配端口号，只有OS能够访问这个端口号
  - 统一编址，也叫做内存映射IO，实现方式是将内存中的一个区域直接分配给IO设备，通常分配位置靠近地址空间的顶端
  - ![](https://raw.githubusercontent.com/workflowBot/image_bed/main/uPic/AP4MhG.png)

- 控制方式

  - 程序直接控制，是同步的，会阻塞
  - 中断驱动方式，是异步的，cpu利用率高，但是会消耗额外的cpu时间处理中断（比如保存上下文）。
  - DMA方式：在中断驱动方式中，一个字符的输入输出就会进行处理，字符需要经过寄存器，效率比较低，为此引入了DMA管理。
    - 基本单元：数据块
    - 传送方式：设备直接将数据送入内存
    - CPU：只有在传输一个块（或者==多个块==）的开始和结束的时候，cpu才会进行干预。
    - 需要如下寄存器
      - CR，存储CPU指令
      - MAR，存储输入数据地址或者输出数据地址
      - DR，临时存储数据
      - DC，存储本次传输的字节数
    - 工作过程
      - CPU向DMA发起请求，设置mar和DC，启动dma，之后执行其他进程；dma传输完毕之后，向cpu发送一个中断信号，cpu进行处理。

- 5.1.6习题

  >1. 共享设备必须是可寻址和可随机访问的设备
  >2. B
  >3. D
  >4. A
  >5. B
  >6. D
  >7. A
  >8. 通道实现了内存和外设之间的信息传输
  >9. A
  >10. C
  >11. D
  >12. C
  >13. 及时性不是设备分配中要考虑的问题
  >14. A
  >15. C
  >16. 通道是一种硬件，不是软件
  >17. C
  >18. C
  >19. D
  >20. A
  >21. D
  >22. B
  >23. A
  >24. C
  >25. B
  >
  >

## 2. 设备独立性软件

- 设备的独立性指的是使用设备对用户进程来说是透明的

- 磁盘高速缓冲，在内存中开辟一个空间，作为磁盘和cpu之间的映射，类似cache

- 缓冲区

  - 单缓冲区，处理一个数据块的时间为$max(C,T) + M$

  - 假设有n块，并且C>=T，那么总时间为$n * (C + M) + T$；如果C<=T，那么总时间为$n * (T + M) + C$

    ![](https://raw.githubusercontent.com/workflowBot/image_bed/main/uPic/TxejxV.png)

  - 双缓冲区

    - 使用两个缓冲区，在处理机读取一个缓冲区的时候，磁盘可以向另一个缓冲区写入数据，处理一块的时间为$max(C + M,T)$

    - 如果有N块数据，并且C+M <= T，那么总时间为$n * T + C + M$；如果C + M >= T，那么总时间为$n * (C + M) + T$

      ![](https://raw.githubusercontent.com/workflowBot/image_bed/main/uPic/KVBUAW.png)

  - 循环缓冲

    - 类似循环队列

  - 缓冲池

    - 顺序：hin->sin->hout->sout

      ![](https://raw.githubusercontent.com/workflowBot/image_bed/main/uPic/gYyOBT.png)

- 设备分配和回收

  - 独占式使用设备
    - 进程对分配的设备进行独占
  - 分时共享使用设备
    - 一个设别分时共享给多个进程
  - spooling方式使用外部设别
    - 使用虚拟设备技术，将设备同时分配给多个进程，实现了对设备IO操作的批处理
    - 不需要外部计算机支持
    - 将独占设备改造为共享设备

- 设备分配数据结构

  - DCT，设备控制表

    - 一个设备控制表表征了一个设备，其中的表项就是设备的各个属性，其指向设备队列的队首指针存储了请求本设备的进程的PCB链表

      ![](https://raw.githubusercontent.com/workflowBot/image_bed/main/uPic/CZNfre.png)

    - SDT，系统设备表，记录了所有连接到系统的设备的情况

      ![](https://raw.githubusercontent.com/workflowBot/image_bed/main/uPic/PIVUUm.png)

- 逻辑设备到物理设备的映射

  - 系统方式：建立一个LUT，将逻辑设备名映射到物理设备名和物理设备驱动程序入口，不允许同名的逻辑设备。适用于单用户系统
  - 用户方式：为每一个用户建立一个LUT，将其存入PCB中

- spooling技术

  - ![](https://raw.githubusercontent.com/workflowBot/image_bed/main/uPic/pTuFGl.png)
  - 在磁盘上开辟输入井和输出井，前者模拟脱机输入磁盘，收容IO设别输入数据，后者模拟脱机输出的输出数据，一个进程的shu

## 3. 磁盘调度

- 调度时间计算	
  - 寻找时间$T_s = m * n + s$，n表示跨越的磁道数量，m一般是常量0.2ms，s表示启动磁臂需要的时间，大约是2ms
  - 旋转延迟时间$T_r = \frac{1}{2r}$，r表示转速
  - 传输时间$T_t = \frac{b}{rN}$，r表示转速，N表示一个磁道的总字节数，b表示要传输的字节数
  - 总时间为上述三个时间之和
- 光盘是可以随机访问，也可以顺序访问
- 磁盘调度的目的是减少寻道时间
- 磁盘格式化
  - 低级格式化
    - 将磁盘分成扇区

  - 高级格式化
    - 将初始的文件系统数据结构存储在磁盘上，写入操作系统引导扇区。

  - 注意磁盘分区不是格式化

- SSD的静态磨损算法发生在没有数据写入的时候，表现比动态的算法更加优秀。
- 写入的时候，选择没有数据的块更好，因为不用擦除。





















